const test=require("tape"),through2=require("../"),crypto=require("crypto"),bl=require("bl"),spigot=require("stream-spigot");test("plain through",function(e){var t=through2(function(e,t,n){this._i?this._i++:this._i=97;var r=new Buffer(e.length);for(var i=0;i<e.length;i++)r[i]=this._i;this.push(r);n()});t.pipe(bl(function(t,n){var r=n.toString("ascii");e.equal("aaaaaaaaaabbbbbcccccccccc",r,"got transformed string");e.end()}));t.write(crypto.randomBytes(10));t.write(crypto.randomBytes(5));t.write(crypto.randomBytes(10));t.end()});test("pipeable through",function(e){var t=through2(function(e,t,n){this._i?this._i++:this._i=97;var r=new Buffer(e.length);for(var i=0;i<e.length;i++)r[i]=this._i;this.push(r);n()});t.pipe(bl(function(t,n){var r=n.toString("ascii");e.equal(r,"aaaaaaaaaaaaaaaaaaaaaaaaa","got transformed string");e.end()}));var n=bl();n.append(crypto.randomBytes(10));n.append(crypto.randomBytes(5));n.append(crypto.randomBytes(10));n.pipe(t)});test("object through",function(e){e.plan(3);var t=through2({objectMode:!0},function(e,t,n){this.push({out:e.in+1});n()}),n=0;t.on("data",function(t){e.deepEqual(t,{out:n===0?102:n==1?203:-99},"got transformed object");n++});t.write({"in":101});t.write({"in":202});t.write({"in":-100});t.end()});test("object through with through2.obj",function(e){e.plan(3);var t=through2.obj(function(e,t,n){this.push({out:e.in+1});n()}),n=0;t.on("data",function(t){e.deepEqual(t,{out:n===0?102:n==1?203:-99},"got transformed object");n++});t.write({"in":101});t.write({"in":202});t.write({"in":-100});t.end()});test("flushing through",function(e){var t=through2(function(e,t,n){this._i?this._i++:this._i=97;var r=new Buffer(e.length);for(var i=0;i<e.length;i++)r[i]=this._i;this.push(r);n()},function(e){this.push(new Buffer([101,110,100]));e()});t.pipe(bl(function(t,n){var r=n.toString("ascii");e.equal(r,"aaaaaaaaaabbbbbccccccccccend","got transformed string");e.end()}));t.write(crypto.randomBytes(10));t.write(crypto.randomBytes(5));t.write(crypto.randomBytes(10));t.end()});test("plain through ctor",function(e){var t=through2.ctor(function(e,t,n){this._i?this._i++:this._i=97;var r=new Buffer(e.length);for(var i=0;i<e.length;i++)r[i]=this._i;this.push(r);n()}),n=new t;n.pipe(bl(function(t,n){var r=n.toString("ascii");e.equal("aaaaaaaaaabbbbbcccccccccc",r,"got transformed string");e.end()}));n.write(crypto.randomBytes(10));n.write(crypto.randomBytes(5));n.write(crypto.randomBytes(10));n.end()});test("reuse through ctor",function(e){e.plan(4);var t=through2.ctor(function(t,n,r){if(!this._i){e.ok(1,"did not contain previous instance data (this._i)");this._i=97}else this._i++;var i=new Buffer(t.length);for(var s=0;s<t.length;s++)i[s]=this._i;this.push(i);r()}),n=t();n.pipe(bl(function(n,r){var i=r.toString("ascii");e.equal("aaaaaaaaaabbbbbcccccccccc",i,"got transformed string");var s=t();s.pipe(bl(function(t,n){var r=n.toString("ascii");e.equal("aaaaaaabbbbccccccc",r,"got transformed string")}));s.write(crypto.randomBytes(7));s.write(crypto.randomBytes(4));s.write(crypto.randomBytes(7));s.end()}));n.write(crypto.randomBytes(10));n.write(crypto.randomBytes(5));n.write(crypto.randomBytes(10));n.end()});test("object through ctor",function(e){e.plan(3);var t=through2.ctor({objectMode:!0},function(e,t,n){this.push({out:e.in+1});n()}),n=new t,r=0;n.on("data",function(t){e.deepEqual(t,{out:r===0?102:r==1?203:-99},"got transformed object");r++});n.write({"in":101});n.write({"in":202});n.write({"in":-100});n.end()});test("pipeable object through ctor",function(e){e.plan(4);var t=through2.ctor({objectMode:!0},function(e,t,n){if(e.temp!=null&&e.unit=="F"){e.temp=(e.temp-32)*5/9;e.unit="C"}this.push(e);n()}),n=t(),r=[-19,-40,100,22];n.on("data",function(t){e.deepEqual(t,{temp:r.shift(),unit:"C"},"got transformed object")});spigot({objectMode:!0},[{temp:-2.2,unit:"F"},{temp:-40,unit:"F"},{temp:212,unit:"F"},{temp:22,unit:"C"}]).pipe(n)});test("object through ctor override",function(e){e.plan(3);var t=through2.ctor(function(e,t,n){this.push({out:e.in+1});n()}),n=t({objectMode:!0}),r=0;n.on("data",function(t){e.deepEqual(t,{out:r===0?102:r==1?203:-99},"got transformed object");r++});n.write({"in":101});n.write({"in":202});n.write({"in":-100});n.end()});test("object settings available in transform",function(e){e.plan(6);var t=through2.ctor({objectMode:!0,peek:!0},function(t,n,r){e.ok(this.options.peek,"reading options from inside _transform");this.push({out:t.in+1});r()}),n=t(),r=0;n.on("data",function(t){e.deepEqual(t,{out:r===0?102:r==1?203:-99},"got transformed object");r++});n.write({"in":101});n.write({"in":202});n.write({"in":-100});n.end()});test("object settings available in transform override",function(e){e.plan(6);var t=through2.ctor(function(t,n,r){e.ok(this.options.peek,"reading options from inside _transform");this.push({out:t.in+1});r()}),n=t({objectMode:!0,peek:!0}),r=0;n.on("data",function(t){e.deepEqual(t,{out:r===0?102:r==1?203:-99},"got transformed object");r++});n.write({"in":101});n.write({"in":202});n.write({"in":-100});n.end()});test("object override extends options",function(e){e.plan(6);var t=through2.ctor({objectMode:!0},function(t,n,r){e.ok(this.options.peek,"reading options from inside _transform");this.push({out:t.in+1});r()}),n=t({peek:!0}),r=0;n.on("data",function(t){e.deepEqual(t,{out:r===0?102:r==1?203:-99},"got transformed object");r++});n.write({"in":101});n.write({"in":202});n.write({"in":-100});n.end()});