function traverseParents(e,t,n,r){var i=[];while(t&&i.length<r){(!n||e._make(t).filter(n).length)&&i.push(t);t=t.parent}return i}var _=require("underscore"),select=require("CSSselect"),utils=require("../utils"),isTag=utils.isTag,find=exports.find=function(e){return this._make(select(e,[].slice.call(this.children())))},parent=exports.parent=function(e){var t=[],n;this.each(function(e,n){var r=n.parent;r&&t.indexOf(r)<0&&t.push(r)});n=this._make(t);arguments.length&&(n=n.filter(e));return n},parents=exports.parents=function(e){var t=[];this.toArray().reverse().forEach(function(n){traverseParents(this,n.parent,e,Infinity).forEach(function(e){t.indexOf(e)===-1&&t.push(e)})},this);return this._make(t)},closest=exports.closest=function(e){var t=[];if(!e)return this._make(t);this.each(function(n,r){var i=traverseParents(this,r,e,1)[0];i&&t.indexOf(i)<0&&t.push(i)}.bind(this));return this._make(t)},next=exports.next=function(){if(!this[0])return this;var e=[];_.forEach(this,function(t){while(t=t.next)if(isTag(t)){e.push(t);return}});return this._make(e)},nextAll=exports.nextAll=function(e){if(!this[0])return this;var t=[];_.forEach(this,function(e){while(e=e.next)isTag(e)&&t.indexOf(e)===-1&&t.push(e)});return this._make(e?select(e,t):t)},nextUntil=exports.nextUntil=function(e,t){if(!this[0])return this;var n=[],r,i;typeof e=="string"?r=select(e,this.nextAll().toArray())[0]:e&&e.cheerio?i=e.toArray():e&&(r=e);_.forEach(this,function(e){while(e=e.next){if(!(r&&e!==r||i&&i.indexOf(e)===-1||!r&&!i))break;isTag(e)&&n.indexOf(e)===-1&&n.push(e)}});return this._make(t?select(t,n):n)},prev=exports.prev=function(){if(!this[0])return this;var e=[];_.forEach(this,function(t){while(t=t.prev)if(isTag(t)){e.push(t);return}});return this._make(e)},prevAll=exports.prevAll=function(e){if(!this[0])return this;var t=[];_.forEach(this,function(e){while(e=e.prev)isTag(e)&&t.indexOf(e)===-1&&t.push(e)});return this._make(e?select(e,t):t)},prevUntil=exports.prevUntil=function(e,t){if(!this[0])return this;var n=[],r,i;typeof e=="string"?r=select(e,this.prevAll().toArray())[0]:e&&e.cheerio?i=e.toArray():e&&(r=e);_.forEach(this,function(e){while(e=e.prev){if(!(r&&e!==r||i&&i.indexOf(e)===-1||!r&&!i))break;isTag(e)&&n.indexOf(e)===-1&&n.push(e)}});return this._make(t?select(t,n):n)},siblings=exports.siblings=function(e){var t=_.filter(this.parent()?this.parent().children():this.siblingsAndMe(),function(e){return isTag(e)&&!this.is(e)},this);e!==undefined&&(t=this._make(select(e,t)));return this._make(t)},children=exports.children=function(e){var t=_.reduce(this,function(e,t){return e.concat(_.filter(t.children,isTag))},[]);return e===undefined?this._make(t):_.isNumber(e)?this._make(t[e]):this._make(t).filter(e)},contents=exports.contents=function(){return this._make(_.reduce(this,function(e,t){e.push.apply(e,t.children);return e},[]))},each=exports.each=function(e){var t=0,n=this.length;while(t<n&&e.call(this._make(this[t]),t,this[t])!==!1)++t;return this},map=exports.map=function(e){return this._make(_.reduce(this,function(t,n,r){var i=e.call(n,r,n);return i==null?t:t.concat(i)},[]))},filter=exports.filter=function(e){var t=_.bind(this._make,this),n;_.isString(e)?n=function(t){return select(e,[t])[0]===t}:_.isFunction(e)?n=function(n,r){return e.call(t(n),r,n)}:e.cheerio?n=e.is.bind(e):n=function(t){return e===t};return t(_.filter(this,n))},first=exports.first=function(){return this[0]?this._make(this[0]):this},last=exports.last=function(){return this[0]?this._make(this[this.length-1]):this},eq=exports.eq=function(e){e=+e;e<0&&(e=this.length+e);return this[e]?this._make(this[e]):this._make([])},slice=exports.slice=function(){return this._make([].slice.apply(this,arguments))},end=exports.end=function(){return this.prevObject||this._make([])};