function whitespace(e){return e===" "||e==="\n"||e==="	"||e==="\f"||e==="\r"}function ifElseState(e,t,n){var r=e.toLowerCase();return e===r?function(e){this._state=e===r?t:n}:function(i){this._state=i===r||i===e?t:n}}function consumeSpecialNameChar(e,t){var n=e.toLowerCase();return function(r){if(r===n||r===e)this._state=t;else{this._state=IN_TAG_NAME;this._index--}}}function Tokenizer(e,t){this._state=TEXT;this._buffer="";this._sectionStart=0;this._index=0;this._baseState=TEXT;this._special=SPECIAL_NONE;this._cbs=t;this._running=!0;this._xmlMode=!!e&&!!e.xmlMode;this._decodeEntities=!!e&&!!e.decodeEntities}function decodeCodePoint(e){var t="";if(e>=55296&&e<=57343||e>1114111)return"ï¿½";e in decodeMap&&(e=decodeMap[e]);if(e>65535){e-=65536;t+=String.fromCharCode(e>>>10&1023|55296);e=56320|e&1023}t+=String.fromCharCode(e);return t}module.exports=Tokenizer;var entityMap=require("./entities/entities.json"),legacyMap=require("./entities/legacy.json"),xmlMap=require("./entities/xml.json"),decodeMap=require("./entities/decode.json"),i=0,TEXT=i++,BEFORE_TAG_NAME=i++,IN_TAG_NAME=i++,IN_SELF_CLOSING_TAG=i++,BEFORE_CLOSING_TAG_NAME=i++,IN_CLOSING_TAG_NAME=i++,AFTER_CLOSING_TAG_NAME=i++,BEFORE_ATTRIBUTE_NAME=i++,IN_ATTRIBUTE_NAME=i++,AFTER_ATTRIBUTE_NAME=i++,BEFORE_ATTRIBUTE_VALUE=i++,IN_ATTRIBUTE_VALUE_DQ=i++,IN_ATTRIBUTE_VALUE_SQ=i++,IN_ATTRIBUTE_VALUE_NQ=i++,BEFORE_DECLARATION=i++,IN_DECLARATION=i++,IN_PROCESSING_INSTRUCTION=i++,BEFORE_COMMENT=i++,IN_COMMENT=i++,AFTER_COMMENT_1=i++,AFTER_COMMENT_2=i++,BEFORE_CDATA_1=i++,BEFORE_CDATA_2=i++,BEFORE_CDATA_3=i++,BEFORE_CDATA_4=i++,BEFORE_CDATA_5=i++,BEFORE_CDATA_6=i++,IN_CDATA=i++,AFTER_CDATA_1=i++,AFTER_CDATA_2=i++,BEFORE_SPECIAL=i++,BEFORE_SPECIAL_END=i++,BEFORE_SCRIPT_1=i++,BEFORE_SCRIPT_2=i++,BEFORE_SCRIPT_3=i++,BEFORE_SCRIPT_4=i++,BEFORE_SCRIPT_5=i++,AFTER_SCRIPT_1=i++,AFTER_SCRIPT_2=i++,AFTER_SCRIPT_3=i++,AFTER_SCRIPT_4=i++,AFTER_SCRIPT_5=i++,BEFORE_STYLE_1=i++,BEFORE_STYLE_2=i++,BEFORE_STYLE_3=i++,BEFORE_STYLE_4=i++,AFTER_STYLE_1=i++,AFTER_STYLE_2=i++,AFTER_STYLE_3=i++,AFTER_STYLE_4=i++,BEFORE_ENTITY=i++,BEFORE_NUMERIC_ENTITY=i++,IN_NAMED_ENTITY=i++,IN_NUMERIC_ENTITY=i++,IN_HEX_ENTITY=i++,j=0,SPECIAL_NONE=j++,SPECIAL_SCRIPT=j++,SPECIAL_STYLE=j++;Tokenizer.prototype._stateText=function(e){if(e==="<"){this._index>this._sectionStart&&this._cbs.ontext(this._getSection());this._state=BEFORE_TAG_NAME;this._sectionStart=this._index}else if(this._decodeEntities&&this._special===SPECIAL_NONE&&e==="&"){this._index>this._sectionStart&&this._cbs.ontext(this._getSection());this._baseState=TEXT;this._state=BEFORE_ENTITY;this._sectionStart=this._index}};Tokenizer.prototype._stateBeforeTagName=function(e){if(e==="/")this._state=BEFORE_CLOSING_TAG_NAME;else if(e===">"||this._special!==SPECIAL_NONE||whitespace(e))this._state=TEXT;else if(e==="!"){this._state=BEFORE_DECLARATION;this._sectionStart=this._index+1}else if(e==="?"){this._state=IN_PROCESSING_INSTRUCTION;this._sectionStart=this._index+1}else if(e==="<"){this._cbs.ontext(this._getSection());this._sectionStart=this._index}else{this._state=!!this._xmlMode||e!=="s"&&e!=="S"?IN_TAG_NAME:BEFORE_SPECIAL;this._sectionStart=this._index}};Tokenizer.prototype._stateInTagName=function(e){if(e==="/"||e===">"||whitespace(e)){this._emitToken("onopentagname");this._state=BEFORE_ATTRIBUTE_NAME;this._index--}};Tokenizer.prototype._stateBeforeCloseingTagName=function(e){if(!whitespace(e))if(e===">")this._state=TEXT;else if(this._special!==SPECIAL_NONE)if(e==="s"||e==="S")this._state=BEFORE_SPECIAL_END;else{this._state=TEXT;this._index--}else{this._state=IN_CLOSING_TAG_NAME;this._sectionStart=this._index}};Tokenizer.prototype._stateInCloseingTagName=function(e){if(e===">"||whitespace(e)){this._emitToken("onclosetag");this._state=AFTER_CLOSING_TAG_NAME;this._index--}};Tokenizer.prototype._stateAfterCloseingTagName=function(e){if(e===">"){this._state=TEXT;this._sectionStart=this._index+1}};Tokenizer.prototype._stateBeforeAttributeName=function(e){if(e===">"){this._cbs.onopentagend();this._state=TEXT;this._sectionStart=this._index+1}else if(e==="/")this._state=IN_SELF_CLOSING_TAG;else if(!whitespace(e)){this._state=IN_ATTRIBUTE_NAME;this._sectionStart=this._index}};Tokenizer.prototype._stateInSelfClosingTag=function(e){if(e===">"){this._cbs.onselfclosingtag();this._state=TEXT;this._sectionStart=this._index+1}else if(!whitespace(e)){this._state=BEFORE_ATTRIBUTE_NAME;this._index--}};Tokenizer.prototype._stateInAttributeName=function(e){if(e==="="||e==="/"||e===">"||whitespace(e)){this._index>this._sectionStart&&this._cbs.onattribname(this._getSection());this._sectionStart=-1;this._state=AFTER_ATTRIBUTE_NAME;this._index--}};Tokenizer.prototype._stateAfterAttributeName=function(e){if(e==="=")this._state=BEFORE_ATTRIBUTE_VALUE;else if(e==="/"||e===">"){this._cbs.onattribend();this._state=BEFORE_ATTRIBUTE_NAME;this._index--}else if(!whitespace(e)){this._cbs.onattribend();this._state=IN_ATTRIBUTE_NAME;this._sectionStart=this._index}};Tokenizer.prototype._stateBeforeAttributeValue=function(e){if(e==='"'){this._state=IN_ATTRIBUTE_VALUE_DQ;this._sectionStart=this._index+1}else if(e==="'"){this._state=IN_ATTRIBUTE_VALUE_SQ;this._sectionStart=this._index+1}else if(!whitespace(e)){this._state=IN_ATTRIBUTE_VALUE_NQ;this._sectionStart=this._index}};Tokenizer.prototype._stateInAttributeValueDoubleQuotes=function(e){if(e==='"'){this._emitToken("onattribdata");this._cbs.onattribend();this._state=BEFORE_ATTRIBUTE_NAME}else if(this._decodeEntities&&e==="&"){this._emitToken("onattribdata");this._baseState=this._state;this._state=BEFORE_ENTITY;this._sectionStart=this._index}};Tokenizer.prototype._stateInAttributeValueSingleQuotes=function(e){if(e==="'"){this._emitToken("onattribdata");this._cbs.onattribend();this._state=BEFORE_ATTRIBUTE_NAME}else if(this._decodeEntities&&e==="&"){this._emitToken("onattribdata");this._baseState=this._state;this._state=BEFORE_ENTITY;this._sectionStart=this._index}};Tokenizer.prototype._stateInAttributeValueNoQuotes=function(e){if(whitespace(e)||e===">"){this._emitToken("onattribdata");this._cbs.onattribend();this._state=BEFORE_ATTRIBUTE_NAME;this._index--}else if(this._decodeEntities&&e==="&"){this._emitToken("onattribdata");this._baseState=this._state;this._state=BEFORE_ENTITY;this._sectionStart=this._index}};Tokenizer.prototype._stateBeforeDeclaration=function(e){this._state=e==="["?BEFORE_CDATA_1:e==="-"?BEFORE_COMMENT:IN_DECLARATION};Tokenizer.prototype._stateInDeclaration=function(e){if(e===">"){this._cbs.ondeclaration(this._getSection());this._state=TEXT;this._sectionStart=this._index+1}};Tokenizer.prototype._stateInProcessingInstruction=function(e){if(e===">"){this._cbs.onprocessinginstruction(this._getSection());this._state=TEXT;this._sectionStart=this._index+1}};Tokenizer.prototype._stateBeforeComment=function(e){if(e==="-"){this._state=IN_COMMENT;this._sectionStart=this._index+1}else this._state=IN_DECLARATION};Tokenizer.prototype._stateInComment=function(e){e==="-"&&(this._state=AFTER_COMMENT_1)};Tokenizer.prototype._stateAfterComment1=ifElseState("-",AFTER_COMMENT_2,IN_COMMENT);Tokenizer.prototype._stateAfterComment2=function(e){if(e===">"){this._cbs.oncomment(this._buffer.substring(this._sectionStart,this._index-2));this._state=TEXT;this._sectionStart=this._index+1}else e!=="-"&&(this._state=IN_COMMENT)};Tokenizer.prototype._stateBeforeCdata1=ifElseState("C",BEFORE_CDATA_2,IN_DECLARATION);Tokenizer.prototype._stateBeforeCdata2=ifElseState("D",BEFORE_CDATA_3,IN_DECLARATION);Tokenizer.prototype._stateBeforeCdata3=ifElseState("A",BEFORE_CDATA_4,IN_DECLARATION);Tokenizer.prototype._stateBeforeCdata4=ifElseState("T",BEFORE_CDATA_5,IN_DECLARATION);Tokenizer.prototype._stateBeforeCdata5=ifElseState("A",BEFORE_CDATA_6,IN_DECLARATION);Tokenizer.prototype._stateBeforeCdata6=function(e){if(e==="["){this._state=IN_CDATA;this._sectionStart=this._index+1}else this._state=IN_DECLARATION};Tokenizer.prototype._stateInCdata=function(e){e==="]"&&(this._state=AFTER_CDATA_1)};Tokenizer.prototype._stateAfterCdata1=ifElseState("]",AFTER_CDATA_2,IN_CDATA);Tokenizer.prototype._stateAfterCdata2=function(e){if(e===">"){this._cbs.oncdata(this._buffer.substring(this._sectionStart,this._index-2));this._state=TEXT;this._sectionStart=this._index+1}else e!=="]"&&(this._state=IN_CDATA)};Tokenizer.prototype._stateBeforeSpecial=function(e){if(e==="c"||e==="C")this._state=BEFORE_SCRIPT_1;else if(e==="t"||e==="T")this._state=BEFORE_STYLE_1;else{this._state=IN_TAG_NAME;this._index--}};Tokenizer.prototype._stateBeforeSpecialEnd=function(e){this._special!==SPECIAL_SCRIPT||e!=="c"&&e!=="C"?this._special!==SPECIAL_STYLE||e!=="t"&&e!=="T"?this._state=TEXT:this._state=AFTER_STYLE_1:this._state=AFTER_SCRIPT_1};Tokenizer.prototype._stateBeforeScript1=consumeSpecialNameChar("R",BEFORE_SCRIPT_2);Tokenizer.prototype._stateBeforeScript2=consumeSpecialNameChar("I",BEFORE_SCRIPT_3);Tokenizer.prototype._stateBeforeScript3=consumeSpecialNameChar("P",BEFORE_SCRIPT_4);Tokenizer.prototype._stateBeforeScript4=consumeSpecialNameChar("T",BEFORE_SCRIPT_5);Tokenizer.prototype._stateBeforeScript5=function(e){if(e==="/"||e===">"||whitespace(e))this._special=SPECIAL_SCRIPT;this._state=IN_TAG_NAME;this._index--};Tokenizer.prototype._stateAfterScript1=ifElseState("R",AFTER_SCRIPT_2,TEXT);Tokenizer.prototype._stateAfterScript2=ifElseState("I",AFTER_SCRIPT_3,TEXT);Tokenizer.prototype._stateAfterScript3=ifElseState("P",AFTER_SCRIPT_4,TEXT);Tokenizer.prototype._stateAfterScript4=ifElseState("T",AFTER_SCRIPT_5,TEXT);Tokenizer.prototype._stateAfterScript5=function(e){if(e===">"||whitespace(e)){this._special=SPECIAL_NONE;this._state=IN_CLOSING_TAG_NAME;this._sectionStart=this._index-6;this._index--}else this._state=TEXT};Tokenizer.prototype._stateBeforeStyle1=consumeSpecialNameChar("Y",BEFORE_STYLE_2);Tokenizer.prototype._stateBeforeStyle2=consumeSpecialNameChar("L",BEFORE_STYLE_3);Tokenizer.prototype._stateBeforeStyle3=consumeSpecialNameChar("E",BEFORE_STYLE_4);Tokenizer.prototype._stateBeforeStyle4=function(e){if(e==="/"||e===">"||whitespace(e))this._special=SPECIAL_STYLE;this._state=IN_TAG_NAME;this._index--};Tokenizer.prototype._stateAfterStyle1=ifElseState("Y",AFTER_STYLE_2,TEXT);Tokenizer.prototype._stateAfterStyle2=ifElseState("L",AFTER_STYLE_3,TEXT);Tokenizer.prototype._stateAfterStyle3=ifElseState("E",AFTER_STYLE_4,TEXT);Tokenizer.prototype._stateAfterStyle4=function(e){if(e===">"||whitespace(e)){this._special=SPECIAL_NONE;this._state=IN_CLOSING_TAG_NAME;this._sectionStart=this._index-5;this._index--}else this._state=TEXT};Tokenizer.prototype._stateBeforeEntity=ifElseState("#",BEFORE_NUMERIC_ENTITY,IN_NAMED_ENTITY);Tokenizer.prototype._stateBeforeNumericEntity=ifElseState("X",IN_HEX_ENTITY,IN_NUMERIC_ENTITY);Tokenizer.prototype._parseNamedEntityStrict=function(){if(this._sectionStart+1<this._index){var e=this._buffer.substring(this._sectionStart+1,this._index),t=this._xmlMode?xmlMap:entityMap;if(t.hasOwnProperty(e)){this._emitPartial(t[e]);this._sectionStart=this._index+1}}};Tokenizer.prototype._parseLegacyEntity=function(){var e=this._sectionStart+1,t=this._index-e;t>6&&(t=6);while(t>=2){var n=this._buffer.substr(e,t);if(legacyMap.hasOwnProperty(n)){this._emitPartial(legacyMap[n]);this._sectionStart+=t+2;break}t--}};Tokenizer.prototype._stateInNamedEntity=function(e){if(e===";"){this._parseNamedEntityStrict();this._sectionStart+1<this._index&&!this._xmlMode&&this._parseLegacyEntity();this._state=this._baseState}else if((e<"a"||e>"z")&&(e<"A"||e>"Z")&&(e<"0"||e>"9")){if(!this._xmlMode)if(this._baseState!==TEXT){if(e!=="="){this._parseNamedEntityStrict();this._sectionStart--}}else{this._parseLegacyEntity();this._sectionStart--}this._state=this._baseState;this._index--}};Tokenizer.prototype._decodeNumericEntity=function(e,t){var n=this._sectionStart+e;if(n!==this._index){var r=this._buffer.substring(n,this._index),i=parseInt(r,t);if(i===i){this._emitPartial(decodeCodePoint(i));this._sectionStart=this._index}}this._state=this._baseState};Tokenizer.prototype._stateInNumericEntity=function(e){if(e===";"){this._decodeNumericEntity(2,10);this._sectionStart++}else if(e<"0"||e>"9"){this._xmlMode?this._state=this._baseState:this._decodeNumericEntity(2,10);this._index--}};Tokenizer.prototype._stateInHexEntity=function(e){if(e===";"){this._decodeNumericEntity(3,16);this._sectionStart++}else if((e<"a"||e>"f")&&(e<"A"||e>"F")&&(e<"0"||e>"9")){this._xmlMode?this._state=this._baseState:this._decodeNumericEntity(3,16);this._index--}};Tokenizer.prototype._cleanup=function(){if(this._sectionStart<0){this._buffer="";this._index=0}else{if(this._state===TEXT){this._sectionStart!==this._index&&this._cbs.ontext(this._buffer.substr(this._sectionStart));this._buffer="";this._index=0}else if(this._sectionStart===this._index){this._buffer="";this._index=0}else{this._buffer=this._buffer.substr(this._sectionStart);this._index-=this._sectionStart}this._sectionStart=0}};Tokenizer.prototype.write=function(e){this._buffer+=e;while(this._index<this._buffer.length&&this._running){var t=this._buffer.charAt(this._index);this._state===TEXT?this._stateText(t):this._state===BEFORE_TAG_NAME?this._stateBeforeTagName(t):this._state===IN_TAG_NAME?this._stateInTagName(t):this._state===BEFORE_CLOSING_TAG_NAME?this._stateBeforeCloseingTagName(t):this._state===IN_CLOSING_TAG_NAME?this._stateInCloseingTagName(t):this._state===AFTER_CLOSING_TAG_NAME?this._stateAfterCloseingTagName(t):this._state===IN_SELF_CLOSING_TAG?this._stateInSelfClosingTag(t):this._state===BEFORE_ATTRIBUTE_NAME?this._stateBeforeAttributeName(t):this._state===IN_ATTRIBUTE_NAME?this._stateInAttributeName(t):this._state===AFTER_ATTRIBUTE_NAME?this._stateAfterAttributeName(t):this._state===BEFORE_ATTRIBUTE_VALUE?this._stateBeforeAttributeValue(t):this._state===IN_ATTRIBUTE_VALUE_DQ?this._stateInAttributeValueDoubleQuotes(t):this._state===IN_ATTRIBUTE_VALUE_SQ?this._stateInAttributeValueSingleQuotes(t):this._state===IN_ATTRIBUTE_VALUE_NQ?this._stateInAttributeValueNoQuotes(t):this._state===BEFORE_DECLARATION?this._stateBeforeDeclaration(t):this._state===IN_DECLARATION?this._stateInDeclaration(t):this._state===IN_PROCESSING_INSTRUCTION?this._stateInProcessingInstruction(t):this._state===BEFORE_COMMENT?this._stateBeforeComment(t):this._state===IN_COMMENT?this._stateInComment(t):this._state===AFTER_COMMENT_1?this._stateAfterComment1(t):this._state===AFTER_COMMENT_2?this._stateAfterComment2(t):this._state===BEFORE_CDATA_1?this._stateBeforeCdata1(t):this._state===BEFORE_CDATA_2?this._stateBeforeCdata2(t):this._state===BEFORE_CDATA_3?this._stateBeforeCdata3(t):this._state===BEFORE_CDATA_4?this._stateBeforeCdata4(t):this._state===BEFORE_CDATA_5?this._stateBeforeCdata5(t):this._state===BEFORE_CDATA_6?this._stateBeforeCdata6(t):this._state===IN_CDATA?this._stateInCdata(t):this._state===AFTER_CDATA_1?this._stateAfterCdata1(t):this._state===AFTER_CDATA_2?this._stateAfterCdata2(t):this._state===BEFORE_SPECIAL?this._stateBeforeSpecial(t):this._state===BEFORE_SPECIAL_END?this._stateBeforeSpecialEnd(t):this._state===BEFORE_SCRIPT_1?this._stateBeforeScript1(t):this._state===BEFORE_SCRIPT_2?this._stateBeforeScript2(t):this._state===BEFORE_SCRIPT_3?this._stateBeforeScript3(t):this._state===BEFORE_SCRIPT_4?this._stateBeforeScript4(t):this._state===BEFORE_SCRIPT_5?this._stateBeforeScript5(t):this._state===AFTER_SCRIPT_1?this._stateAfterScript1(t):this._state===AFTER_SCRIPT_2?this._stateAfterScript2(t):this._state===AFTER_SCRIPT_3?this._stateAfterScript3(t):this._state===AFTER_SCRIPT_4?this._stateAfterScript4(t):this._state===AFTER_SCRIPT_5?this._stateAfterScript5(t):this._state===BEFORE_STYLE_1?this._stateBeforeStyle1(t):this._state===BEFORE_STYLE_2?this._stateBeforeStyle2(t):this._state===BEFORE_STYLE_3?this._stateBeforeStyle3(t):this._state===BEFORE_STYLE_4?this._stateBeforeStyle4(t):this._state===AFTER_STYLE_1?this._stateAfterStyle1(t):this._state===AFTER_STYLE_2?this._stateAfterStyle2(t):this._state===AFTER_STYLE_3?this._stateAfterStyle3(t):this._state===AFTER_STYLE_4?this._stateAfterStyle4(t):this._state===BEFORE_ENTITY?this._stateBeforeEntity(t):this._state===BEFORE_NUMERIC_ENTITY?this._stateBeforeNumericEntity(t):this._state===IN_NAMED_ENTITY?this._stateInNamedEntity(t):this._state===IN_NUMERIC_ENTITY?this._stateInNumericEntity(t):this._state===IN_HEX_ENTITY?this._stateInHexEntity(t):this._cbs.onerror(Error("unknown _state"),this._state);this._index++}this._cleanup()};Tokenizer.prototype.pause=function(){this._running=!1};Tokenizer.prototype.resume=function(){this._running=!0};Tokenizer.prototype.end=function(e){e&&this.write(e);this._sectionStart<this._index&&this._handleTrailingData();this._cbs.onend()};Tokenizer.prototype._handleTrailingData=function(){var e=this._buffer.substr(this._sectionStart);if(this._state===IN_CDATA||this._state===AFTER_CDATA_1||this._state===AFTER_CDATA_2)this._cbs.oncdata(e);else if(this._state===IN_COMMENT||this._state===AFTER_COMMENT_1||this._state===AFTER_COMMENT_2)this._cbs.oncomment(e);else if(this._state===IN_TAG_NAME)this._cbs.onopentagname(e);else if(this._state===BEFORE_ATTRIBUTE_NAME||this._state===BEFORE_ATTRIBUTE_VALUE||this._state===AFTER_ATTRIBUTE_NAME)this._cbs.onopentagend();else if(this._state===IN_ATTRIBUTE_NAME)this._cbs.onattribname(e);else if(this._state===IN_ATTRIBUTE_VALUE_SQ||this._state===IN_ATTRIBUTE_VALUE_DQ||this._state===IN_ATTRIBUTE_VALUE_NQ){this._cbs.onattribdata(e);this._cbs.onattribend()}else if(this._state===IN_CLOSING_TAG_NAME)this._cbs.onclosetag(e);else if(this._state===IN_NAMED_ENTITY&&!this._xmlMode){this._parseLegacyEntity();if(--this._sectionStart<this._index){this._state=this._baseState;this._handleTrailingData()}}else if(this._state===IN_NUMERIC_ENTITY&&!this._xmlMode){this._decodeNumericEntity(2,10);if(this._sectionStart<this._index){this._state=this._baseState;this._handleTrailingData()}}else if(this._state===IN_HEX_ENTITY&&!this._xmlMode){this._decodeNumericEntity(3,16);if(this._sectionStart<this._index){this._state=this._baseState;this._handleTrailingData()}}else this._cbs.ontext(e)};Tokenizer.prototype.reset=function(){Tokenizer.call(this,{xmlMode:this._xmlMode,decodeEntities:this._decodeEntities},this._cbs)};Tokenizer.prototype._getSection=function(){return this._buffer.substring(this._sectionStart,this._index)};Tokenizer.prototype._emitToken=function(e){this._cbs[e](this._getSection());this._sectionStart=-1};Tokenizer.prototype._emitPartial=function(e){this._baseState!==TEXT?this._cbs.onattribdata(e):this._cbs.ontext(e)};