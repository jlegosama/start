function DomHandler(e,t,n){if(typeof e=="object"){n=t;t=e;e=null}else if(typeof t=="function"){n=t;t=defaultOpts}this._callback=e;this._options=t||defaultOpts;this._elementCB=n;this.dom=[];this._done=!1;this._tagStack=[]}var ElementType=require("domelementtype"),re_whitespace=/\s+/g,defaultOpts={normalizeWhitespace:!1};DomHandler.prototype.onreset=function(){DomHandler.call(this,this._callback,this._options,this._elementCB)};DomHandler.prototype.onend=function(){if(this._done)return;this._done=!0;this._handleCallback(null)};DomHandler.prototype._handleCallback=DomHandler.prototype.onerror=function(e){if(typeof this._callback=="function")this._callback(e,this.dom);else if(e)throw e};DomHandler.prototype.onclosetag=function(){var e=this._tagStack.pop();this._elementCB&&this._elementCB(e)};DomHandler.prototype._addDomElement=function(e){var t=this._tagStack[this._tagStack.length-1],n=t?t.children:this.dom,r=n[n.length-1];e.next=null;this._options.withDomLvl1&&(e.__proto__=NodePrototype);if(r){e.prev=r;r.next=e}else e.prev=null;n.push(e);e.parent=t||null};var NodePrototype={get firstChild(){var e=this.children;return e&&e[0]||null},get lastChild(){var e=this.children;return e&&e[e.length-1]||null},get nodeType(){return nodeTypes[this.type]||nodeTypes.element}},domLvl1={tagName:"name",childNodes:"children",parentNode:"parent",previousSibling:"prev",nextSibling:"next",nodeValue:"data"},nodeTypes={element:1,text:3,cdata:4,comment:8};Object.keys(domLvl1).forEach(function(e){var t=domLvl1[e];Object.defineProperty(NodePrototype,e,{get:function(){return this[t]||null},set:function(e){this[t]=e;return e}})});DomHandler.prototype.onopentag=function(e,t){var n={type:e==="script"?ElementType.Script:e==="style"?ElementType.Style:ElementType.Tag,name:e,attribs:t,children:[]};this._addDomElement(n);this._tagStack.push(n)};DomHandler.prototype.ontext=function(e){var t=this._options.normalizeWhitespace||this._options.ignoreWhitespace,n;if(!this._tagStack.length&&this.dom.length&&(n=this.dom[this.dom.length-1]).type===ElementType.Text)t?n.data=(n.data+e).replace(re_whitespace," "):n.data+=e;else if(this._tagStack.length&&(n=this._tagStack[this._tagStack.length-1])&&(n=n.children[n.children.length-1])&&n.type===ElementType.Text)t?n.data=(n.data+e).replace(re_whitespace," "):n.data+=e;else{t&&(e=e.replace(re_whitespace," "));this._addDomElement({data:e,type:ElementType.Text})}};DomHandler.prototype.oncomment=function(e){var t=this._tagStack[this._tagStack.length-1];if(t&&t.type===ElementType.Comment){t.data+=e;return}var n={data:e,type:ElementType.Comment};this._addDomElement(n);this._tagStack.push(n)};DomHandler.prototype.oncdatastart=function(){var e={children:[{data:"",type:ElementType.Text}],type:ElementType.CDATA};this._addDomElement(e);this._tagStack.push(e)};DomHandler.prototype.oncommentend=DomHandler.prototype.oncdataend=function(){this._tagStack.pop()};DomHandler.prototype.onprocessinginstruction=function(e,t){this._addDomElement({name:e,data:t,type:ElementType.Directive})};module.exports=DomHandler;