/*jshint node:true */"use strict";var util=require("util"),events=require("events"),EventEmitter=events.EventEmitter,runTask=require("./lib/runTask"),Orchestrator=function(){EventEmitter.call(this);this.doneCallback=undefined;this.seq=[];this.tasks={};this.isRunning=!1};util.inherits(Orchestrator,EventEmitter);Orchestrator.prototype.reset=function(){this.isRunning&&this.stop(null);this.tasks={};this.seq=[];this.isRunning=!1;this.doneCallback=undefined;return this};Orchestrator.prototype.add=function(e,t,n){if(!n&&typeof t=="function"){n=t;t=undefined}t=t||[];n=n||function(){};if(!e)throw new Error("Task requires a name");if(typeof e!="string")throw new Error("Task requires a name that is a string");if(typeof n!="function")throw new Error("Task "+e+" requires a function that is a function");if(!Array.isArray(t))throw new Error("Task "+e+" can't support dependencies that is not an array of strings");t.forEach(function(t){if(typeof t!="string")throw new Error("Task "+e+" dependency "+t+" is not a string")});this.tasks[e]={fn:n,dep:t,name:e};return this};Orchestrator.prototype.task=function(e,t,n){if(!t&&!n)return this.tasks[e];this.add(e,t,n)};Orchestrator.prototype.hasTask=function(e){return!!this.tasks[e]};Orchestrator.prototype.start=function(){var e,t,n=[],r,i,s=[];e=Array.prototype.slice.call(arguments,0);if(e.length){r=e[e.length-1];if(typeof r=="function"){this.doneCallback=r;e.pop()}for(i=0;i<e.length;i++){t=e[i];if(typeof t=="string")n.push(t);else{if(!Array.isArray(t))throw new Error("pass strings or arrays of strings");n.concat(t)}}}this.isRunning?this._resetSpecificTasks(n):this._resetAllTasks();this.isRunning&&(n=n.concat(this.seq));if(n.length<1)for(i in this.tasks)this.tasks.hasOwnProperty(i)&&n.push(this.tasks[i].name);s=[];try{this.sequence(this.tasks,n,s,[])}catch(o){if(o){o.missingTask&&this.emit("task_not_found",{message:o.message,task:o.missingTask,err:o});o.recursiveTasks&&this.emit("task_recursion",{message:o.message,recursiveTasks:o.recursiveTasks,err:o})}this.stop(o);return this}this.seq=s;this.emit("start",{message:"seq: "+this.seq.join(",")});this.isRunning||(this.isRunning=!0);this._runStep();return this};Orchestrator.prototype.stop=function(e,t){this.isRunning=!1;if(e)this.emit("err",{message:"orchestration failed",err:e});else if(t)this.emit("stop",{message:"orchestration succeeded"});else{e="orchestration aborted";this.emit("err",{message:"orchestration aborted",err:e})}if(this.doneCallback)this.doneCallback(e);else if(e&&!this.listeners("err").length)throw e};Orchestrator.prototype.sequence=require("sequencify");Orchestrator.prototype.allDone=function(){var e,t,n=!0;for(e=0;e<this.seq.length;e++){t=this.tasks[this.seq[e]];if(!t.done){n=!1;break}}return n};Orchestrator.prototype._resetTask=function(e){if(e){e.done&&(e.done=!1);delete e.start;delete e.stop;delete e.duration;delete e.hrDuration;delete e.args}};Orchestrator.prototype._resetAllTasks=function(){var e;for(e in this.tasks)this.tasks.hasOwnProperty(e)&&this._resetTask(this.tasks[e])};Orchestrator.prototype._resetSpecificTasks=function(e){var t,n,r;if(e&&e.length)for(t=0;t<e.length;t++){n=e[t];r=this.tasks[n];if(r){this._resetTask(r);r.dep&&r.dep.length&&this._resetSpecificTasks(r.dep)}}};Orchestrator.prototype._runStep=function(){var e,t;if(!this.isRunning)return;for(e=0;e<this.seq.length;e++){t=this.tasks[this.seq[e]];!t.done&&!t.running&&this._readyToRunTask(t)&&this._runTask(t);if(!this.isRunning)return}this.allDone()&&this.stop(null,!0)};Orchestrator.prototype._readyToRunTask=function(e){var t=!0,n,r,i;if(e.dep.length)for(n=0;n<e.dep.length;n++){r=e.dep[n];i=this.tasks[r];if(!i){this.stop("can't run "+e.name+" because it depends on "+r+" which doesn't exist");t=!1;break}if(!i.done){t=!1;break}}return t};Orchestrator.prototype._stopTask=function(e,t){e.duration=t.duration;e.hrDuration=t.hrDuration;e.running=!1;e.done=!0};Orchestrator.prototype._emitTaskDone=function(e,t,n){e.args||(e.args={task:e.name});e.args.duration=e.duration;e.args.hrDuration=e.hrDuration;e.args.message=e.name+" "+t;var r="stop";if(n){e.args.err=n;r="err"}this.emit("task_"+r,e.args)};Orchestrator.prototype._runTask=function(e){var t=this;e.args={task:e.name,message:e.name+" started"};this.emit("task_start",e.args);e.running=!0;runTask(e.fn.bind(this),function(n,r){t._stopTask.call(t,e,r);t._emitTaskDone.call(t,e,r.runMethod,n);if(n)return t.stop.call(t,n);t._runStep.call(t)})};var events=["start","stop","err","task_start","task_stop","task_err","task_not_found","task_recursion"],listenToEvent=function(e,t,n){e.on(t,function(e){e.src=t;n(e)})};Orchestrator.prototype.onAll=function(e){var t;if(typeof e!="function")throw new Error("No callback specified");for(t=0;t<events.length;t++)listenToEvent(this,events[t],e)};module.exports=Orchestrator;