"use strict";function writeArray(e,t){e.forEach(function(e){t.write(e)});t.end()}function readStream(e,t){var n=[];e.on("data",function(e){n.push(e)});e.on("error",t);e.on("end",function(e){t(null,n)})}function pauseStream(e,t){var n="number"==typeof e?function(){return Math.random()<e}:"function"==typeof e?e:.1,r=t?"number"==typeof t?function(e){setTimeout(e,t)}:t:process.nextTick;return es.through(function(e){if(!this.paused&&n()){console.log("PAUSE STREAM PAUSING");this.pause();var t=this;r(function(){console.log("PAUSE STREAM RESUMING");t.resume()})}console.log("emit ('data', "+e+")");this.emit("data",e)})}var map=require("../"),it=require("it-is"),u=require("ubelt"),spec=require("stream-spec"),from=require("from"),Stream=require("stream"),es=require("event-stream");exports["simple map applied to a stream"]=function(e){var t=[1,2,3,7,5,3,1,9,0,2,4,6],n=map(function(e,t){t(null,e*2)});spec(n).through().validateOnExit();it(n).has({readable:!0,writable:!0});readStream(n,function(n,r){it(r).deepEqual(t.map(function(e){return e*2}));e.done()});writeArray(t,n)};exports["stream comes back in the correct order"]=function(e){var t=[3,2,1],n=map(function(e,t){setTimeout(function(){t(null,e)},100*e)});readStream(n,function(n,r){it(r).deepEqual(t);e.done()});writeArray(t,n)};exports["continues on error event with failures `true`"]=function(e){var t=[1,2,3],n=map(function(e,t){t(new Error("Something gone wrong"),e)},{failures:!0});readStream(n,function(n,r){it(r).deepEqual(t);e.done()});writeArray(t,n)};exports["pipe two maps together"]=function(e){function n(e,t){t(null,e*2)}var t=[1,2,3,7,5,3,1,9,0,2,4,6],r=map(n),i=map(n);r.pipe(i);spec(r).through().validateOnExit();spec(i).through().validateOnExit();readStream(i,function(n,r){it(r).deepEqual(t.map(function(e){return e*4}));e.done()});writeArray(t,r)};exports["map will not call end until the callback"]=function(e){var t=map(function(e,t){process.nextTick(function(){t(null,e*2)})});spec(t).through().validateOnExit();t.write("x");t.end();t.on("end",function(){e.done()})};exports["emit failures with opts.failures === `ture`"]=function(e){var t=new Error("INTENSIONAL ERROR"),n=map(function(){throw t},{failures:!0});n.on("failure",function(n){it(n).equal(t);e.done()});n.write("hello")};exports["emit error thrown"]=function(e){var t=new Error("INTENSIONAL ERROR"),n=map(function(){throw t});n.on("error",function(n){it(n).equal(t);e.done()});n.write("hello")};exports["emit error calledback"]=function(e){var t=new Error("INTENSIONAL ERROR"),n=map(function(e,n){n(t)});n.on("error",function(n){it(n).equal(t);e.done()});n.write("hello")};exports["do not emit drain if not paused"]=function(e){var t=map(function(e,t){u.delay(t)(null,1);return!0});spec(t).through().pausable().validateOnExit();t.on("drain",function(){it(!1).ok("should not emit drain unless the stream is paused")});it(t.write("hello")).equal(!0);it(t.write("hello")).equal(!0);it(t.write("hello")).equal(!0);setTimeout(function(){t.end()},10);t.on("end",e.done)};exports["emits drain if paused, when all "]=function(e){var t=0,n=!1,r=map(function(e,n){t++;u.delay(function(){t--;n(null,1)})();console.log("WRITE",!1);return!1});spec(r).through().validateOnExit();r.on("drain",function(){n=!0;it(t).equal(0,"should emit drain when all maps are done")});it(r.write("hello")).equal(!1);it(r.write("hello")).equal(!1);it(r.write("hello")).equal(!1);process.nextTick(function(){r.end()},10);r.on("end",function(){console.log("end");it(n).ok("shoud have emitted drain before end");e.done()})};exports["map applied to a stream with filtering"]=function(e){var t=[1,2,3,7,5,3,1,9,0,2,4,6],n=map(function(e,t){e%2?t(null,e*2):t()});readStream(n,function(n,r){it(r).deepEqual(t.filter(function(e){return e%2}).map(function(e){return e*2}));e.done()});spec(n).through().validateOnExit();writeArray(t,n)};