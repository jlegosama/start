// parse a 512-byte header block to a data object, or vice-versa
// If the data won't fit nicely in a simple header, then generate
// the appropriate extended header file, and return that.
function TarHeader(e){if(!(this instanceof TarHeader))return new TarHeader(e);e&&this.decode(e)}function encode(e){if(!!e||this instanceof TarHeader){e=e||this;var t=e.block=new Buffer(512);if(e.prefix){e.path=e.prefix+"/"+e.path;e.prefix=""}e.needExtended=!1;if(e.mode){typeof e.mode=="string"&&(e.mode=parseInt(e.mode,8));e.mode=e.mode&511}for(var n=0;fields[n]!==null;n++){var r=fields[n],i=fieldOffs[n],s=fieldEnds[n],o;switch(r){case"cksum":break;case"prefix":break;case"type":var u=e.type||"0";if(u.length>1){u=tar.types[e.type];u||(u="0")}writeText(t,i,s,u);break;case"path":var a=Buffer.byteLength(e.path),f=fieldSize[fields.path],l=fieldSize[fields.prefix];if(a>f&&a<=f+l){var c=a-1-f,h=l,p=!1,d=new Buffer(e.path);for(var v=c;v<=h;v++)if(d[v]===slash||d[v]===bslash){p=v;break}if(p!==!1){prefix=d.slice(0,p).toString("utf8");path=d.slice(p+1).toString("utf8");o=writeText(t,i,s,path);i=fieldOffs[fields.prefix];s=fieldEnds[fields.prefix];o=writeText(t,i,s,prefix)||o;break}}var m=fieldOffs[fields.prefix],g=fieldEnds[fields.prefix];writeText(t,m,g,"");default:o=numeric[r]?writeNumeric(t,i,s,e[r]):writeText(t,i,s,e[r]||"")}e.needExtended=e.needExtended||o}var i=fieldOffs[fields.cksum],s=fieldEnds[fields.cksum];writeNumeric(t,i,s,calcSum.call(this,t));return t}throw new Error("encode must be called on a TarHeader, or supplied an object")}function writeNumeric(e,t,n,r){var i=n-t,s=MAXNUM[i]||0;r=r||0;if(r instanceof Date||Object.prototype.toString.call(r)==="[object Date]")r=r.getTime()/1e3;if(r>s||r<0){write256(e,t,n,r);return!0}var o=Math.floor(r).toString(8);r<MAXNUM[i-1]&&(o+=" ");o.length<i&&(o=(new Array(i-o.length)).join("0")+o);if(o.length!==i-1)throw new Error("invalid length: "+JSON.stringify(o)+"\n"+"expected: "+i);e.write(o,t,i,"utf8");e[n-1]=0}function write256(e,t,n,r){var i=e.slice(t,n),s=r>=0;i[0]=s?128:255;s||(r*=-1);var o=[];do{var u=r%256;o.push(u);r=(r-u)/256}while(r);var a=o.length,f=i.length-a;for(var l=1;l<f;l++)i[l]=s?0:255;var c=!0;for(l=a;l>0;l--){var h=o[a-l];if(s)i[f+l]=h;else if(c&&h===0)i[f+l]=0;else if(c){c=!1;i[f+l]=256-h}else i[f+l]=255-h}}function writeText(e,t,n,r){var i=Buffer.byteLength(r),s=Math.min(i,n-t),o=i!==r.length||i>s;s>0&&e.write(r,t,s,"utf8");for(var u=t+s;u<n;u++)e[u]=0;return o}function calcSum(e){e=e||this.block;assert(Buffer.isBuffer(e)&&e.length===512);if(!e)throw new Error("Need block to checksum");var t=0,n=fieldOffs[fields.cksum],r=fieldEnds[fields.cksum];for(var i=0;i<fieldOffs[fields.cksum];i++)t+=e[i];for(var i=n;i<r;i++)t+=space;for(var i=r;i<512;i++)t+=e[i];return t}function checkSum(e){var t=calcSum.call(this,e);e=e||this.block;var n=e.slice(fieldOffs[fields.cksum],fieldEnds[fields.cksum]);n=parseNumeric(n);return n===t}function decode(e){e=e||this.block;assert(Buffer.isBuffer(e)&&e.length===512);this.block=e;this.cksumValid=this.checkSum();var t=null;for(var n=0;fields[n]!==null;n++){var r=fields[n],i=e.slice(fieldOffs[n],fieldEnds[n]);switch(r){case"ustar":if(i.toString()!=="ustar\0"){this.ustar=!1;return}this.ustar=i.toString();break;case"prefix":var s=parseNumeric(i.slice(131,143)),o=parseNumeric(i.slice(143,155));if((i[130]===0||i[130]===space)&&typeof s=="number"&&typeof o=="number"&&i[143]===space&&i[155]===space){this.atime=s;this.ctime=o;i=i.slice(0,130)}t=i.toString("utf8").replace(/\0+$/,"");break;default:numeric[r]?this[r]=parseNumeric(i):this[r]=i.toString("utf8").replace(/\0+$/,"")}}t&&(this.path=t+"/"+this.path)}function parse256(e){var t;if(e[0]===128)t=!0;else{if(e[0]!==255)return null;t=!1}var n=!1,r=[];for(var i=e.length-1;i>0;i--){var s=e[i];if(t)r.push(s);else if(n&&s===0)r.push(0);else if(n){n=!1;r.push(256-s)}else r.push(255-s)}for(var o=0,i=0,u=r.length;i<u;i++)o+=r[i]*Math.pow(256,i);return t?o:-1*o}function parseNumeric(e){if(e[0]&128)return parse256(e);var t=e.toString("utf8").split("\0")[0].trim(),n=parseInt(t,8);return isNaN(n)?null:n}module.exports=TarHeader;var tar=require("../tar.js"),fields=tar.fields,fieldOffs=tar.fieldOffs,fieldEnds=tar.fieldEnds,fieldSize=tar.fieldSize,numeric=tar.numeric,assert=require("assert").ok,space=" ".charCodeAt(0),slash="/".charCodeAt(0),bslash=process.platform==="win32"?"\\".charCodeAt(0):null;TarHeader.prototype={decode:decode,encode:encode,calcSum:calcSum,checkSum:checkSum};TarHeader.parseNumeric=parseNumeric;TarHeader.encode=encode;TarHeader.decode=decode;var MAXNUM={12:8589934591,11:1073741823,8:2097151,7:262143};