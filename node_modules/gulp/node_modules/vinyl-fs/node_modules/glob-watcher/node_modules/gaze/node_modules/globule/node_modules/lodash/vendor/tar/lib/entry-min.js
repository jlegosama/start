// A passthrough read/write stream that sets its properties
// based on a header, extendedHeader, and globalHeader
//
// Can be either a file system object of some sort, or
// a pax/ustar metadata entry.
function Entry(e,t,n){Stream.call(this);this.readable=!0;this.writable=!0;this._needDrain=!1;this._paused=!1;this._reading=!1;this._ending=!1;this._ended=!1;this._remaining=0;this._queue=[];this._index=0;this._queueLen=0;this._read=this._read.bind(this);this.props={};this._header=e;this._extended=t||{};this._global={};var r=this;Object.keys(n||{}).forEach(function(e){r._global[e]=n[e]});this._setProps()}module.exports=Entry;var TarHeader=require("./header.js"),tar=require("../tar"),assert=require("assert").ok,Stream=require("stream").Stream,inherits=require("../vendor/inherits/inherits.js"),fstream=require("../vendor/fstream/fstream.js").Abstract;inherits(Entry,Stream,{write:function(e){this._ending&&this.error("write() after end()",null,!0);this._remaining===0&&this.error("invalid bytes past eof");e.length>this._remaining&&(e=e.slice(0,this._remaining));this._remaining-=e.length;var t=this._queueLen;this._queue.push(e);this._queueLen++;this._read();if(this._paused||t>0){this._needDrain=!0;return!1}return!0},end:function(e){e&&this.write(e);this._ending=!0;this._read()},pause:function(){this._paused=!0;this.emit("pause")},resume:function(){this.emit("resume");this._paused=!1;this._read();return this._queueLen-this._index>1},_read:function(){if(this._paused||this._reading||this._ended)return;this._reading=!0;if(this._index<this._queueLen){var e=this._queue[this._index++];this.emit("data",e)}if(this._index>=this._queueLen){this._queue.length=this._queueLen=this._index=0;if(this._needDrain){this._needDrain=!1;this.emit("drain")}if(this._ending){this._ended=!0;this.emit("end")}}var t=this._maxQueueLen;if(this._queueLen>t&&this._index>0){t=Math.min(this._index,t);this._index-=t;this._queueLen-=t;this._queue=this._queue.slice(t)}this._reading=!1},_setProps:function(){var e=this._header,t=this._extended,n=this._global,r=this.props,i=tar.fields;for(var s=0;i[s]!==null;s++){var o=i[s],u=e[o];typeof u!="undefined"&&(r[o]=u)}[n,t].forEach(function(e){Object.keys(e).forEach(function(t){typeof e[t]!="undefined"&&(r[t]=e[t])})});["path","linkpath"].forEach(function(e){r.hasOwnProperty(e)&&(r[e]=r[e].split("\0")[0])});["mtime","ctime","atime"].forEach(function(e){r.hasOwnProperty(e)&&(r[e]=new Date(r[e]*1e3))});var a;switch(tar.types[r.type]){case"OldFile":case"ContiguousFile":a="File";break;case"GNUDumpDir":a="Directory";break;case undefined:a="Unknown";break;case"Link":case"SymbolicLink":case"CharacterDevice":case"BlockDevice":case"Directory":case"FIFO":default:a=tar.types[r.type]}this.type=a;this.path=r.path;this.size=r.size;this._remaining=r.size},warn:fstream.warn,error:fstream.error});