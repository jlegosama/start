var vfs=require("../"),path=require("path"),fs=require("graceful-fs"),rimraf=require("rimraf"),bufEqual=require("buffer-equal"),through=require("through2"),File=require("vinyl"),should=require("should");require("mocha");var wipeOut=function(e){rimraf(path.join(__dirname,"./out-fixtures/"),e)},dataWrap=function(e){return function(t,n,r){e(t);r()}};describe("dest stream",function(){beforeEach(wipeOut);afterEach(wipeOut);it("should pass through writes with cwd",function(e){var t=path.join(__dirname,"./fixtures/test.coffee"),n=new File({base:__dirname,cwd:__dirname,path:t,contents:null}),r=function(){s.length.should.equal(1);s[0].should.equal(n);e()},i=vfs.dest("./out-fixtures/",{cwd:__dirname}),s=[];bufferStream=through.obj(dataWrap(s.push.bind(s)),r);i.pipe(bufferStream);i.write(n);i.end()});it("should pass through writes with default cwd",function(e){var t=path.join(__dirname,"./fixtures/test.coffee"),n=new File({base:__dirname,cwd:__dirname,path:t,contents:null}),r=function(){s.length.should.equal(1);s[0].should.equal(n);e()},i=vfs.dest(path.join(__dirname,"./out-fixtures/")),s=[];bufferStream=through.obj(dataWrap(s.push.bind(s)),r);i.pipe(bufferStream);i.write(n);i.end()});it("should not write null files",function(e){var t=path.join(__dirname,"./fixtures/test.coffee"),n=path.join(__dirname,"./fixtures/"),r=path.join(__dirname,"./out-fixtures/test.coffee"),i=__dirname,s=path.join(__dirname,"./out-fixtures"),o=new File({base:n,cwd:__dirname,path:t,contents:null}),u=function(){f.length.should.equal(1);f[0].should.equal(o);f[0].cwd.should.equal(i,"cwd should have changed");f[0].base.should.equal(s,"base should have changed");f[0].path.should.equal(r,"path should have changed");fs.existsSync(r).should.equal(!1);e()},a=vfs.dest("./out-fixtures/",{cwd:__dirname}),f=[];bufferStream=through.obj(dataWrap(f.push.bind(f)),u);a.pipe(bufferStream);a.write(o);a.end()});it("should write buffer files to the right folder with relative cwd",function(e){var t=path.join(__dirname,"./fixtures/test.coffee"),n=path.join(__dirname,"./fixtures/"),r=path.join(__dirname,"./out-fixtures/test.coffee"),i=__dirname,s=path.join(__dirname,"./out-fixtures"),o=fs.readFileSync(t),u=new File({base:n,cwd:__dirname,path:t,contents:o}),a=function(){l.length.should.equal(1);l[0].should.equal(u);l[0].cwd.should.equal(i,"cwd should have changed");l[0].base.should.equal(s,"base should have changed");l[0].path.should.equal(r,"path should have changed");fs.existsSync(r).should.equal(!0);bufEqual(fs.readFileSync(r),o).should.equal(!0);e()},f=vfs.dest("./out-fixtures/",{cwd:path.relative(process.cwd(),__dirname)}),l=[];bufferStream=through.obj(dataWrap(l.push.bind(l)),a);f.pipe(bufferStream);f.write(u);f.end()});it("should write buffer files to the right folder",function(e){var t=path.join(__dirname,"./fixtures/test.coffee"),n=path.join(__dirname,"./fixtures/"),r=path.join(__dirname,"./out-fixtures/test.coffee"),i=fs.readFileSync(t),s=__dirname,o=path.join(__dirname,"./out-fixtures"),u=new File({base:n,cwd:__dirname,path:t,contents:i}),a=function(){l.length.should.equal(1);l[0].should.equal(u);l[0].cwd.should.equal(s,"cwd should have changed");l[0].base.should.equal(o,"base should have changed");l[0].path.should.equal(r,"path should have changed");fs.existsSync(r).should.equal(!0);bufEqual(fs.readFileSync(r),i).should.equal(!0);e()},f=vfs.dest("./out-fixtures/",{cwd:__dirname}),l=[];bufferStream=through.obj(dataWrap(l.push.bind(l)),a);f.pipe(bufferStream);f.write(u);f.end()});it("should write streaming files to the right folder",function(e){var t=path.join(__dirname,"./fixtures/test.coffee"),n=path.join(__dirname,"./fixtures/"),r=path.join(__dirname,"./out-fixtures/test.coffee"),i=fs.readFileSync(t),s=__dirname,o=path.join(__dirname,"./out-fixtures"),u=through.obj(),a=new File({base:n,cwd:__dirname,path:t,contents:u}),f=function(){c.length.should.equal(1);c[0].should.equal(a);c[0].cwd.should.equal(s,"cwd should have changed");c[0].base.should.equal(o,"base should have changed");c[0].path.should.equal(r,"path should have changed");fs.existsSync(r).should.equal(!0);bufEqual(fs.readFileSync(r),i).should.equal(!0);e()},l=vfs.dest("./out-fixtures/",{cwd:__dirname}),c=[];bufferStream=through.obj(dataWrap(c.push.bind(c)),f);l.pipe(bufferStream);l.write(a);setTimeout(function(){u.write(i);u.end()},100);l.end()});it("should write directories to the right folder",function(e){var t=path.join(__dirname,"./fixtures/test"),n=path.join(__dirname,"./fixtures/"),r=path.join(__dirname,"./out-fixtures/test"),i=__dirname,s=path.join(__dirname,"./out-fixtures"),o=new File({base:n,cwd:__dirname,path:t,contents:null,stat:{isDirectory:function(){return!0}}}),u=function(){f.length.should.equal(1);f[0].should.equal(o);f[0].cwd.should.equal(i,"cwd should have changed");f[0].base.should.equal(s,"base should have changed");f[0].path.should.equal(r,"path should have changed");fs.existsSync(r).should.equal(!0);fs.lstatSync(r).isDirectory().should.equal(!0);e()},a=vfs.dest("./out-fixtures/",{cwd:__dirname}),f=[];bufferStream=through.obj(dataWrap(f.push.bind(f)),u);a.pipe(bufferStream);a.write(o);a.end()})});