var core=require("./core"),fs=require("fs"),path=require("path"),caller=require("./caller.js"),nodeModulesPaths=require("./node-modules-paths.js");module.exports=function(t,n,r){function f(e,t,r){if(typeof t=="function"){r=t;t=n.package}(function s(n){if(n.length===0)return r(null,undefined,t);var o=e+n[0];i(o,function(e,i){e?r(e):i?r(null,o,t):s(n.slice(1))})})([""].concat(o))}function l(e,t,r){if(typeof t=="function"){r=t;t=n.package}var o=path.join(e,"/package.json");i(o,function(i,u){if(i)return r(i);if(!u)return f(path.join(e,"/index"),t,r);s(o,function(t,i){if(t)return r(t);try{var s=JSON.parse(i)}catch(t){}n.packageFilter&&(s=n.packageFilter(s,e));if(s.main){f(path.resolve(e,s.main),s,function(t,n,i){if(t)return r(t);if(n)return r(null,n,i);if(!i)return f(path.join(e,"/index"),i,r);var s=path.resolve(e,i.main);l(s,i,function(t,n,i){if(t)return r(t);if(n)return r(null,n,i);f(path.join(e,"/index"),i,r)})});return}f(path.join(e,"/index"),s,r)})})}function c(e,t,r){(function i(t){if(t.length===0)return r(null,undefined);var n=t[0];f(path.join(n,"/",e),undefined,function(s,o,u){if(s)return r(s);if(o)return r(null,o,u);l(path.join(n,"/",e),undefined,function(e,n,s){if(e)return r(e);if(n)return r(null,n,s);i(t.slice(1))})})})(nodeModulesPaths(t,n))}if(typeof n=="function"){r=n;n={}}n||(n={});var i=n.isFile||function(e,t){fs.stat(e,function(e,n){e&&e.code==="ENOENT"?t(null,!1):e?t(e):t(null,n.isFile()||n.isFIFO())})},s=n.readFile||fs.readFile,o=n.extensions||[".js"],u=n.basedir||path.dirname(caller()),a=n.moduleDirectory||"node_modules";n.paths=n.paths||[];t.match(/^(?:\.\.?\/|\/|([A-Za-z]:)?\\)/)?f(path.resolve(u,t),function(e,n,i){e?r(e):n?r(null,n,i):l(path.resolve(u,t),function(e,n,i){e?r(e):n?r(null,n,i):r(new Error("Cannot find module '"+t+"' from '"+u+"'"))})}):c(t,u,function(e,n,i){if(e)r(e);else if(n)r(null,n,i);else{if(core[t])return r(null,t);r(new Error("Cannot find module '"+t+"' from '"+u+"'"))}})};