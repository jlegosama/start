var path=require("path"),test=require("tap").test,resolve=require("../");test("async foo",function(e){e.plan(9);var t=__dirname+"/resolver";resolve("./foo",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/foo.js");e.equal(i,undefined)});resolve("./foo.js",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/foo.js");e.equal(i,undefined)});resolve("./foo",{basedir:t,"package":{main:"resolver"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/foo.js");e.equal(i.main,"resolver")});resolve("./foo.js",{basedir:t,"package":{main:"resolver"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/foo.js");e.equal(i.main,"resolver")});resolve("foo",{basedir:t},function(n){e.equal(n.message,"Cannot find module 'foo' from '"+path.resolve(t)+"'")})});test("bar",function(e){e.plan(6);var t=__dirname+"/resolver";resolve("foo",{basedir:t+"/bar"},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/bar/node_modules/foo/index.js");e.equal(i,undefined)});resolve("foo",{basedir:t+"/bar"},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/bar/node_modules/foo/index.js");e.equal(i,undefined)});resolve("foo",{basedir:t+"/bar","package":{main:"bar"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/bar/node_modules/foo/index.js");e.equal(i,undefined)})});test("baz",function(e){e.plan(4);var t=__dirname+"/resolver";resolve("./baz",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/baz/quux.js");e.equal(i.main,"quux.js")});resolve("./baz",{basedir:t,"package":{main:"resolver"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/baz/quux.js");e.equal(i.main,"quux.js")})});test("biz",function(e){e.plan(24);var t=__dirname+"/resolver/biz/node_modules";resolve("./grux",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/grux/index.js");e.equal(i,undefined)});resolve("./grux",{basedir:t,"package":{main:"biz"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/grux/index.js");e.equal(i.main,"biz")});resolve("./garply",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/garply/lib/index.js");e.equal(i.main,"./lib")});resolve("./garply",{basedir:t,"package":{main:"biz"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/garply/lib/index.js");e.equal(i.main,"./lib")});resolve("tiv",{basedir:t+"/grux"},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/tiv/index.js");e.equal(i,undefined)});resolve("tiv",{basedir:t+"/grux","package":{main:"grux"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/tiv/index.js");e.equal(i,undefined)});resolve("tiv",{basedir:t+"/garply"},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/tiv/index.js");e.equal(i,undefined)});resolve("tiv",{basedir:t+"/garply","package":{main:"./lib"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/tiv/index.js");e.equal(i,undefined)});resolve("grux",{basedir:t+"/tiv"},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/grux/index.js");e.equal(i,undefined)});resolve("grux",{basedir:t+"/tiv","package":{main:"tiv"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/grux/index.js");e.equal(i,undefined)});resolve("garply",{basedir:t+"/tiv"},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/garply/lib/index.js");e.equal(i.main,"./lib")});resolve("garply",{basedir:t+"/tiv","package":{main:"tiv"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/garply/lib/index.js");e.equal(i.main,"./lib")})});test("quux",function(e){e.plan(2);var t=__dirname+"/resolver/quux";resolve("./foo",{basedir:t,"package":{main:"quux"}},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/foo/index.js");e.equal(i.main,"quux")})});test("normalize",function(e){e.plan(2);var t=__dirname+"/resolver/biz/node_modules/grux";resolve("../grux",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/index.js");e.equal(i,undefined)})});test("cup",function(e){e.plan(3);var t=__dirname+"/resolver";resolve("./cup",{basedir:t,extensions:[".js",".coffee"]},function(n,r){n&&e.fail(n);e.equal(r,t+"/cup.coffee")});resolve("./cup.coffee",{basedir:t},function(n,r){n&&e.fail(n);e.equal(r,t+"/cup.coffee")});resolve("./cup",{basedir:t,extensions:[".js"]},function(n,r){e.equal(n.message,"Cannot find module './cup' from '"+path.resolve(t)+"'")})});test("mug",function(e){e.plan(3);var t=__dirname+"/resolver";resolve("./mug",{basedir:t},function(n,r){n&&e.fail(n);e.equal(r,t+"/mug.js")});resolve("./mug",{basedir:t,extensions:[".coffee",".js"]},function(n,r){n&&e.fail(n);e.equal(r,t+"/mug.coffee")});resolve("./mug",{basedir:t,extensions:[".js",".coffee"]},function(n,r){e.equal(r,t+"/mug.js")})});test("other path",function(e){e.plan(4);var t=__dirname+"/resolver",n=t+"/bar",r=t+"/other_path";resolve("root",{basedir:n,paths:[r]},function(n,r){n&&e.fail(n);e.equal(r,t+"/other_path/root.js")});resolve("lib/other-lib",{basedir:n,paths:[r]},function(n,r){n&&e.fail(n);e.equal(r,t+"/other_path/lib/other-lib.js")});resolve("root",{basedir:n},function(t,r){e.equal(t.message,"Cannot find module 'root' from '"+path.resolve(n)+"'")});resolve("zzz",{basedir:n,paths:[r]},function(t,r){e.equal(t.message,"Cannot find module 'zzz' from '"+path.resolve(n)+"'")})});test("incorrect main",function(e){e.plan(1);var t=__dirname+"/resolver",n=t+"/incorrect_main";resolve("./incorrect_main",{basedir:t},function(t,r,i){t&&e.fail(t);e.equal(r,n+"/index.js")})});test("without basedir",function(e){e.plan(1);var t=__dirname+"/resolver/without_basedir",n=require(t+"/main.js");n(e,function(n,r,i){n?e.fail(n):e.equal(r,t+"/node_modules/mymodule.js")})});test("#25: node modules with the same name as node stdlib modules",function(e){e.plan(1);var t=__dirname+"/resolver/punycode";resolve("punycode",{basedir:t},function(n,r,i){n&&e.fail(n);e.equal(r,t+"/node_modules/punycode/index.js")})});